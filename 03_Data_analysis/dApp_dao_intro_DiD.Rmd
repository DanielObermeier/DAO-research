---
title: "DApp_intro_dao_DiD"
author: "Daniel Obermeier"
date: '2023-01-12'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Load libraries
```{r}

library(did)
library(zoo)
library(dplyr)
library(sandwich)
library(lmtest)
library(fixest)
library(plm)
library(tidyverse)
library(bacondecomp)
library(modelsummary) # alternative to stargazer
library(etable)
library(ggplot2)
library(ggthemes)

```


## Import the data set

```{r}
#read csv
df.panel <- read.csv("dapp_dao_usage_panel.csv", sep=";", header=TRUE)

# fill nas
df.panel[is.na(df.panel)] <- 0


# drop column X 
df.panel = subset(df.panel, select = -c(X) )

# rename variable
names(df.panel)[names(df.panel) == "intro_dao_pro_prop"] <- "intro_dao_end_prop"


```


## Data preprocessing

Convert dates 
```{r}

# convert date string to date type
df.panel$date <- as.Date(df.panel$date_key, format="%Y-%m-%d")

# create year quarter variable for grouping
df.panel$yearqtr <- as.yearqtr(df.panel$date, format = "%Y-%m-%d")


df.panel$yearmonth <- format(as.Date(df.panel$date), "%Y-%m")

# convert first treatment to quarter
# convert date string to date type
df.panel$start_first_prop <- as.Date(df.panel$start_first_prop, format="%Y-%m-%d")



```



Create treatment dummies and treatment month and quarter
```{r}

# create year quarter variable for grouping
df.panel$treat_yearqtr <- as.yearqtr(df.panel$start_first_prop, format = "%Y-%m-%d")

# created variable that indicates in which month of a year a dapp introduced a DAO
df.panel$treat_yearmonth <- format(as.Date(df.panel$start_first_prop), "%Y-%m")


# create a variables that indicates if a dApp was treated
df.panel <- df.panel %>% mutate(treated = case_when(!is.na(start_first_prop)~1,
                                                        is.na(start_first_prop)~0))


```



Clean the data 
```{r}

# Remove duplicate rows
df.panel <- df.panel %>% distinct(dapp_name, date_key, .keep_all = TRUE)

# use this command to find duplicated observations
#df.panel %>% group_by(dapp_name) %>% summarise(obs = n()) %>% arrange(desc(obs))


# Filter dApps with no category
# filter row with empty categories (might be caused by special characters)
df.panel <- df.panel %>% filter(category != "")

```


Transform variables
```{r}

df.panel$transactions_log <- log(df.panel$transactions +1)
df.panel$eoa_log <- log(df.panel$eoa +1)
df.panel$SUM_txn_value_GWEI_log <- log(df.panel$SUM_txn_value_GWEI +1)

```




Aggregate panel on quarterly level
```{r}


df.panel_yqtr <- df.panel %>%  group_by(yearqtr, dapp_name, treat_yearqtr, category) %>%
                                        summarise(sum_txn = sum(transactions),
                                                  avg_txn = mean(transactions),
                                                  sum_txn_log = sum(transactions_log),
                                                  avg_txn_log = mean(transactions_log),
                                                  avg_eoa = mean(eoa),
                                                  avf_eoa_log = mean(eoa_log),
                                                  sum_value = sum(SUM_txn_value_GWEI),
                                                  avg_value = mean(AVG_txn_value_GWEI),
                                                  sum_value_log = sum(SUM_txn_value_GWEI_log),
                                                  avg_value_log = mean(SUM_txn_value_GWEI_log)
                                                  )



# convert yearqtr string into int (for did package)
df.panel_yqtr$yearqtr_int <- as.integer(as.factor(df.panel_yqtr$yearqtr))


# create treatment group variable that indicates in which period the unit got treated (treatment group)
df.panel_yqtr_grouped <- df.panel_yqtr %>% group_by(yearqtr, yearqtr_int) %>% summarise() # get continuous integer for every year month
df.panel_yqtr <- merge(df.panel_yqtr, df.panel_yqtr_grouped, by.x = c("treat_yearqtr"), by.y = c("yearqtr"), all.x = TRUE)

# rename variables
names(df.panel_yqtr)[names(df.panel_yqtr) == "yearqtr_int.x"] <- "yearqtr_int"
names(df.panel_yqtr)[names(df.panel_yqtr) == "yearqtr_int.y"] <- "treated_yearqtr_int"


# fill NaNs 
df.panel_yqtr["treated_yearqtr_int"][is.na(df.panel_yqtr["treated_yearqtr_int"])] <- 0 # not possible to fill it directly with 0 as case_when requires same type


# add a numeric id (required for did package)
df.panel_yqtr$dapp_id <- with(df.panel_yqtr, as.integer(factor(dapp_name, levels = unique(dapp_name))))


#df.panel_test <- df.panel_yqtr %>% select(dapp_name) #, dapp_name, transactions, treat_yearqtr_int, category) 

```



Aggregate panel on year month level
```{r}
# group dataset by month
df.panel_ymonth <- df.panel %>%  group_by(yearmonth, dapp_name, treat_yearmonth, category) %>%
                                        summarise(sum_txn = sum(transactions),
                                                  avg_txn = mean(transactions),
                                                  sum_txn_log = sum(transactions_log),
                                                  avg_txn_log = mean(transactions_log),
                                                  avg_eoa = mean(eoa),
                                                  avf_eoa_log = mean(eoa_log),
                                                  sum_value = sum(SUM_txn_value_GWEI),
                                                  avg_value = mean(AVG_txn_value_GWEI),
                                                  sum_value_log = sum(SUM_txn_value_GWEI_log),
                                                  avg_value_log = mean(SUM_txn_value_GWEI_log)
                                                  )


df.panel_ymonth$yearmonth_int <- as.integer(as.factor(df.panel_ymonth$yearmonth))


# create treatment group variable that indicates in which period the unit got treated (treatment group)
df.panel_ymonth_grouped <- df.panel_ymonth %>% group_by(yearmonth, yearmonth_int) %>% summarise() # get continuous integer for every year month
df.panel_ymonth <- merge(df.panel_ymonth, df.panel_ymonth_grouped, by.x = c("treat_yearmonth"), by.y = c("yearmonth"), all.x = TRUE)

# rename variables
names(df.panel_ymonth)[names(df.panel_ymonth) == "yearmonth_int.x"] <- "yearqtr_int"
names(df.panel_ymonth)[names(df.panel_ymonth) == "yearmonth_int.y"] <- "treat_yearmonth_int"


# fill NaNs 
df.panel_ymonth["treat_yearmonth_int"][is.na(df.panel_ymonth["treat_yearmonth_int"])] <- 0 # not possible to fill it directly with 0 as case_when requires same type


# add a numeric id (required for did package)
df.panel_ymonth$dapp_id <- with(df.panel_ymonth, as.integer(factor(dapp_name, levels = unique(dapp_name))))



```





# Descriptive statistics
```{r}

# treated dapps per month
df.panel.grouped_category <- df.panel %>% group_by(dapp_name, category) %>% summarise(treated = mean(treated)) %>% group_by(category) %>% summarise(treated = sum(treated)) %>% arrange(desc(treated))
df.panel.grouped_category %>% ggplot(aes(x = reorder(category, -treated), y = treated, label = treated)) + geom_bar(stat = "identity", fill = "blue") + geom_text(size = 3, vjust=-0.5) + theme_tufte() +theme(axis.text.x = element_text(size = 18, angle = 90, vjust = 0.5, hjust=1)) # + theme_tufte()

# treated units by month 
df.panel.grouped_month <- df.panel %>% filter(!is.na(treat_yearqtr)) %>% group_by(dapp_name, treat_yearqtr) %>% summarise(treated = mean(treated)) %>% group_by(treat_yearqtr) %>% summarise(treated = sum(treated)) 
df.panel.grouped_month %>% ggplot(aes(x = treat_yearqtr, y = treated, label = treated)) + geom_bar(stat = "identity", fill = "blue") + geom_text(size = 3, vjust=-0.5) + theme_tufte() +theme(axis.text.x = element_text(size = 15, angle = 90, vjust = 0.5, hjust=1))


# treated units by month 
df.panel.grouped_quarter <- df.panel %>% filter(!is.na(treat_yearmonth)) %>% group_by(dapp_name, treat_yearmonth) %>% summarise(treated = mean(treated)) %>% group_by(treat_yearmonth) %>% summarise(treated = sum(treated)) 
df.panel.grouped_quarter %>% ggplot(aes(x = treat_yearmonth, y = treated, label = treated)) + geom_bar(stat = "identity", fill = "blue") + geom_text(size = 3, vjust=-0.5) + theme_tufte() +theme(axis.text.x = element_text(size = 15, angle = 90, vjust = 0.5, hjust=1))



```




# TWFE DID (standard approach)
Problem: This does not account for heterogeneous treatment effects accross groups and periods and can lead to an inconsistent estimate of the average treatment effect. This problem is caused as TWFE estimates some weighted average of the treatment effects and due to heterogenity of these treatment effects some weighted treatment effects can be negative. 


https://tidy-finance.org/difference-in-differences.html (estimation with fixest)
https://theeffectbook.net/ch-DifferenceinDifference.html (on diff-in-diff estimation) -> explains approaches that account for heterogenious treatment effects

## TWFE with PLM package
```{r}

# create an unfiltered panel date frame 
pdf.regress <- pdata.frame(df.panel, index = c("dapp_name","date"))


twfe <- plm(log(transactions+1) ~ 
              intro_dao_start_prop +
              factor(category),
              data = pdf.regress, model="within", effect ="twoways") 

summary(twfe)

se.plm.test <- coeftest(twfe, vcov=vcovHC(twfe,type="HC0",cluster="group"))
se.plm.test

```

## TWFE with fixest package
Fixest documentation for OLS: https://lrberge.github.io/fixest/reference/feols.html, https://rdrr.io/cran/fixest/man/feols.html
```{r}

# fe model with fixest
model_with_fe_1 <- feols(
  fml = transactions_log ~ intro_dao_start_prop | dapp_name + date,
  panel.id=c('dapp_name', 'date'), 
  vcov = "NW", #alternative idd, cluster, or twoway, NW
  data = df.panel
)

model_with_fe_2 <- feols(
  fml = eoa_log ~ intro_dao_start_prop | dapp_name + date,
  panel.id=c('dapp_name', 'date'), 
  vcov = "NW", #alternative idd, cluster, or twoway, NW
  data = df.panel
)


model_with_fe_3 <- feols(
  fml = transactions_log ~ intro_dao_end_prop | dapp_name + date,
  panel.id=c('dapp_name', 'date'), 
  vcov = "NW", #alternative idd, cluster, or twoway, NW
  data = df.panel
)

model_with_fe_4 <- feols(
  fml = eoa_log ~ intro_dao_end_prop | dapp_name + date,
  panel.id=c('dapp_name', 'date'), 
  vcov = "NW", #alternative idd, cluster, or twoway, NW
  data = df.panel
)



# create table output
#modelsummary(model_with_fe)


# data.frame output
df <- etable(list(model_with_fe_1, model_with_fe_2, model_with_fe_3, model_with_fe_4), tex=FALSE, dict = c(intro_dao_start_prop = "DiD_start_prop", intro_dao_pro_prop = "DiD_end_prop"))


df
# Latex output
#etable(list(model1, model2), tex=TRUE)

```



## Decomposition of TWFE in all 2x2 estimates and their weights
https://cran.r-project.org/web/packages/bacondecomp/vignettes/bacon.html
```{r}



df.panel$date_int <- as.integer(as.numeric(df.panel$date))


df.panel.defi <- df.panel %>% filter(category == "DeFi")


df_bacon <- bacon(transactions_log ~ intro_dao_start_prop,
                  data = df.panel.defi,
                  id_var = "dapp_name",
                  time_var = "date_int")

df_bacon

```




# DiD with multiple time periods (Callaway and Sant'Anna 2021)

Link to paper: https://doi.org/10.1016/j.jeconom.2020.12.001
Link to tutorial: https://cran.r-project.org/web/packages/did/vignettes/did-basics.html



## Compute DiD

Estimate cohort specific atts
```{r}

mw.attgt <- att_gt(yname = "sum_txn_log",
                   gname = "treated_yearqtr_int",
                   idname = "dapp_id",
                   tname = "yearqtr_int",
                   xformla = ~1,
                   data = df.panel_yqtr,
                   # control_group = "notyettreated" # includes not yet treated into the control groups 
                   )

summary(mw.attgt)


# set ylim so that all plots have the same scale along y-axis
ggdid(mw.attgt, ylim = c(-.1,.1))

```
Aggregate cohort specific atts
```{r}

mw.dyn <- aggte(mw.attgt, type = "dynamic")
summary(mw.dyn)

ggdid(mw.dyn, ylim = c(-.3,.3))

```




### Aggregate treatment effects

```{r}

mw.simple <- aggte(mw.attgt, type = "simple")
summary(mw.simple)

#ggdid(mw.simple, ylim = c(-.3,.3))


mw.dyn <- aggte(mw.attgt, type = "dynamic")
summary(mw.dyn)

ggdid(mw.dyn, ylim = c(-.3,.3))


```


## Analysis by category of dApps

```{r}

```

